<?php
$_months = array('', 'Janvier', 'F&eacute;vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao&ucirc;t', 'Septembre', 'Octobre', 'Novembre', 'D&eacute;cembre');
$_days = array('D', 'L', 'M', 'M', 'J', 'V', 'S');

$_M = intval(date('m', time()));
$_Y = intval(date('Y', time()));
$_events = array();
$_dates=array();//liste des dates qui ont un evenement.
?>


	<!-- construction liste evenements -->
	<?php
	<BOUCLE_evenements(ARTICLES){tout}{type_mot == ^Agenda}>
		$_date = ereg_replace("^([0-9]{4})-([0-9]{2})-([0-9]{2}).*$", "\\1\\2\\3", '#DATE_REDAC');
		if ($_date > date("Ymd", mktime(0, 0, 0, $_M, -7, $_Y)) && $_date < date("Ymd", mktime(0, 0, 0, $_M + 1, 7, $_Y))) {
			if (!isset($_events[$_date])) { $_events[$_date] = array(); }
			$_events[$_date][] = array('link' => '#URL_ARTICLE', 'title' => '[(#TITRE)]'); 
			}
			//echo "#TITRE<br>";
	</BOUCLE_evenements>
?>

<?php  ?>


	<script type="text/javascript" language="JavaScript">
		function showDiv(tid) {document.getElementById(tid).style.display = "";}
		function hideDiv(tid) {document.getElementById(tid).style.display = "none";}
			
		function creerEncart2(elav,elapres,tab){
			var encart = document.createElement("div");
			encart.id="encart";
			var liste = document.createElement("ul");
			for (var i=0; i<tab.length; i++)
			{
				var item = document.createElement("li");
				var texte_item = document.createTextNode(tab[i]);
				item.appendChild(texte_item);
				liste.appendChild(item);
			}
			encart.appendChild(liste);
			document.getElementById(elav).insertBefore(encart, document.getElementById(elapres));
		}
			
		function effacerEncart(elav,a_effacer){
			document.getElementById(elav).removeChild(document.getElementById(a_effacer));
			}
		
	</script>

	<!-- agenda miniature: en tete -->	
	<div id="menu-calendar" class="menu-left-block">
	<h3>Calendrier</h3>
	
	
	
	<table>
	<tbody>
	
	<tr> 
		<th colspan="7" class="agendaNav">
		<?php
			echo '<a href="agenda.php3" title="Vue du mois">'.$_months[$_M].'</a>&nbsp;';
			echo '<a href="agen_an.php3" title="Vue de l\'année">'.$_Y.'</a>';
		?>
		</th> 
	</tr>
	
	<!-- agenda miniature: affichage jours et evenements -->
	<tr> 
	<?php
	for($_i = 1; $_i < 8; $_i++) { echo '<th>'.$_days[$_i%7].'</th>'; }
	$_TempD = 1;
	$_Time = mktime(0, 0, 0, $_M, 1, $_Y);
	if(date('w', $_Time) != 1) {
		echo '</tr><tr>';
		$_tmp = '';
		while(date('w', $_Time) != 1) {
			$_TempD--;
			$_Time = mktime(0, 0, 0, $_M, $_TempD, $_Y);
			$_case = '<td width="14%" class="agenda">';
		        $_date=date('Ymd', $_Time);
			if (isset($_events[$_date])) {
				if (count($_events[$_date]) == 1) {
				  $_case .= '<a href='.$_events[$_date][0]['link'].' title="'.$_events[$_date][0]['title'].'">';
				} else {
				  $_case .= '<a href="agenda.php3?" title="'.count($_events[$_date]).' &eacute;v&eacute;nements">';
				}
				$_case .= date('j', $_Time).'</a>';
			} else {$_case .= date('j', $_Time);}
			$_tmp = $_case.'</td>'.$_tmp;
		}
		echo $_tmp;
	}
	$_TempD = 1;
	$_Time = mktime(0, 0, 0, $_M, 1, $_Y);	
	

	while((date('m', $_Time) == $_M) || (date('w', $_Time) != 1)) {
		if(date('w', $_Time) == 1) { echo '</tr><tr>'; }
		
		echo '<td width="14%" align=center';
		
		echo ' class=agenda';
		if(date('m', $_Time) == $_M)//mois?
		{
			if(date(W) == date(W,$_Time))//semaine?
			{
			    //jour?
				echo (date('Ymd', $_Time) == date('Ymd')) ? 'Day' : 'MonthWeek';
			}
			else
			{echo 'Month';}
		}
		else 
		{
			//semaine?
			echo (date(W) == date(W,$_Time)) ? 'Week' : '';
		}
		
		
		$_date=date('Ymd', $_Time);
		
		if (isset($_events[$_date]))
		{
			//Pour voir les noms des events en passant la souris sur la case du jour.
			$_dates[]=$_date;
			
			//echo ' onmouseover="javascript:showDiv(\'encart'.$_date.'\');" ';
			//echo ' onmouseout="javascript:hideDiv(\'encart'.$_date.'\');" ';
			
			
			$tabjs="(";
			foreach ($_events[$_date] as $ev){$tabjs.='\''.$ev['title'].'\',';}
			$tabjs.=")";
			$tabjs = str_replace(",)", ")", $tabjs);
			
			//echo ' onmouseover="javascript:creerEncart(\'menu-calendar\',\'bidon\',\''.$contenu.'\');" ';
			echo " onmouseover=\"javascript:creerEncart('menu-calendar','bidon',new Array".$tabjs.");\" ";
			echo " onmouseout=\"javascript:effacerEncart('menu-calendar','encart');\" ";
			
			echo ' >';
			
			if (count($_events[$_date]) == 1) {
			  echo '<a href='.$_events[$_date][0]['link'].' title="'.$_events[$_date][0]['title'].'">';
			} else {
			  echo '<a href="agenda.php3?" title="'.count($_events[$_date]).' &eacute;v&eacute;nements">';
			}
			echo date('j', $_Time).'</a>';
		} 
		else 
		{
			echo ' >'.date('j', $_Time);
		}
		echo '</td>';
		$_TempD++;
		$_Time = mktime(0, 0, 0, $_M, $_TempD, $_Y);
	}
	?>
	</tr>
	
	</tbody>
	</table>
	<i id=bidon></i>
	</div>
	<!--test pour insertion de div dynamique en javascript-->
	
	
	<?php	
	/*
	$style='display:none;background-color:#FFFFCC;position:absolute;';
	
		foreach($_dates as $v) 
		{
			echo '<div id=encart'.$v.' style="'.$style.'">';
			
			echo '<ul>';
			foreach ($_events[$v] as $ev)
				{echo '<li>'.$ev['title'].'</li>';}
			echo '</ul>';
			echo '</div>';
		}
	*/
	?>
	