

<?php
$months = array('', 'Janvier', 'F&eacute;vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao&ucirc;t', 'Septembre', 'Octobre', 'Novembre', 'D&eacute;cembre');
$days = array('Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi');
if (!isset($date) || $date == '') $date = date('Y-m-d');

ereg("^([0-9]{4})-([0-9]{2})-([0-9]{2}).*$", $date, $regs);
$cal_day = mktime(0, 0, 0, $regs[2], $regs[3], $regs[1]);

$D = date('d', $cal_day);
$M = date('m', $cal_day);
$Y = date('Y', $cal_day);

// Le Menu de sélection de genre
$mot_cle = array();
$mot_cle['Tout'] = 'Tout';


// liste des mots cles du groupe de mot cles agenda 
<BOUCLE_m(MOTS){tout}{type=Agenda}>
$mot_cle['#TITRE']='#TITRE';
</BOUCLE_m>

//print_r ($mot_cle);


$str_motcle = strlen($str_motcle)>0 ? $str_motcle : 'Tout';
$date=!isset($date) ? date("Y-m-01") : $date;
//$titrePage = 'Agenda - '.$months[$M].' '.$Y;


//echo "<br>$str_motcle<br>";

// Construction liste des événements (1 liste par jour => liste des jours)
$events = array();

//les articles contenant au moins un des mots clef du groupe agenda
<BOUCLE_evts_com(ARTICLES){type_mot == Agenda}{par date_redac}>
	if ('#DATE_REDAC' != '') {
		$dateEvt = ereg_replace("^([0-9]{4})-([0-9]{2})-([0-9]{2}).*$", "\\1\\2\\3", '#DATE_REDAC');
		if (!isset($events[$dateEvt])) 
			{$events[$dateEvt] = array();}
		
		$specif=false;
		//liste des mots clefs de cet article (appartenant au groupe agenda) 
		<BOUCLE_motcle(MOTS){id_article}{type == Agenda}>
			if(#TITRE==$str_motcle)
				$specif= true;
		</BOUCLE_motcle>
		if ($str_motcle=="Tout" || $specif) {
			$events[$dateEvt][] = array(
							 'rub' => '#ID_RUBRIQUE',
							 'link' => '#URL_ARTICLE',
							 'title' => '[(#TITRE|texte_script)]',
							 'logo' => '[<img src="IMG/(#LOGO_ARTICLE_RUBRIQUE|fichier)" />]');
		}
	}
</BOUCLE_evts_com>

?>




<html>
	<head>
		<title>#NOM_SITE_SPIP</title>
		<link rel="stylesheet" type="text/css" href="taust.css" media="screen" title="defaut" />       
	</head>


<body>
	<a href="sommaire.php3"><img id="logo" src="IMG/logo_taust.png" alt="" /></a>
	<h1>Le <span>Taust</span>, chauds et beurrés depuis 1991</h1>
	
	<div id="main">
	
		<INCLURE (top.php3)>
		<br class="separator"/>
		<INCLURE (menu.php3)>
		
		
		<div id="content">
		<h2 class="titre" id="titre_agenda">Agenda</h2>
			<!-- Fabrication du tableau : l'en tête -->
			<table id="agenda">
			<form name="navigation" method="get">
			<tr>
			<th colspan="7" class="agendaNav" >
			<a href="agenda.php3?date=<?php echo (($M - 1 > 0) ? $Y : ($Y - 1)); ?>-<?php printf('%02d', ($M - 1) > 0 ? 
			($M - 1) : 12); ?>-01&str_motcle=<?php echo $str_motcle ?>" ><img src="IMG/agt_back.png" alt="Précédent"/></a>
			
			<select name="var_nav_month">
			<?php
			for($i=1;$i<13;$i++) 
				echo '<option value='.sprintf('%02d',$i).' '.($i==$M?'selected=selected ':' ').'>'.$months[$i].'</option>';
			?>
			</select>
				
			<select name="var_nav_year">
			<?php
				for($i=2000; $i<2010; $i++)
					echo '<option value='.$i.' '.($i==$Y?' selected=selected ':' ').'>'.$i.'</option>';
			?>
			</select>
        	
			<!-- Construction Menu sélection  attention double niveau car plusieurs groupes de mots-clés !
			-->
			<select name="var_nav_cle">
			<?php
			foreach($mot_cle as $key=>$value)
				echo '<option value='.$key.($key==$str_motcle?' selected ':' ').'>'.($key=='Tout'?'':'-> ').$key.'</option>';
			?>
			</select>
			
			<input type="button" value="Afficher" 
			onClick="document.location.href='agenda.php3?date=' + window.document.navigation.var_nav_year.value + '-' + window.document.navigation.var_nav_month.value + '-01&str_motcle=' + window.document.navigation.var_nav_cle.value ; return false;" />
			
			<input type="button" value="Aujourd'hui" onClick="document.location.href='agenda.php3?date=<?php echo (date('Y-m-d')); ?>&str_motcle=<?php echo $str_motcle ?>'; return false;" />
			
			<a href="agenda.php3?date=<?php echo (($M + 1 < 13) ? $Y : ($Y + 1)); ?>-<?php printf('%02d', ($M + 1) < 13 ? ($M + 1) : 1); ?>-01&str_motcle=<?php echo $str_motcle ?>"
			><img src="IMG/agt_forward.png" alt="Suivant"/></a>
			
			</th></tr>
			</form>

			<!-- les cases des jours -->
			<!-- Fabrication du tableau : les données -->
			<tr> 
			<?php
			
			for($i = 1; $i < 8; $i++) 
				{echo '<th width="14%" class="agendaHead">'.$days[$i%7].'</th>';}
			$TempD = 1;
			$Time = mktime(0, 0, 0, $M, 1, $Y);
			if(date('w', $Time) != 1) 
			{
			    // jours du mois precedent
				echo '</tr><tr>';
				$tmp = '';
				while(date('w', $Time) != 1) 
				{
					$TempD--;
					$Time = mktime(0, 0, 0, $M, $TempD, $Y);
					$case = '<td width="14%" height="50" class="agenda">';
					$case .= date('j', $Time);
					if (isset($events[date('Ymd', $Time)])) 
					{
					$case.='<ul class="agenda_events">';
						while (list(, $event) = each($events[date('Ymd', $Time)])) 
						{
							$case .= '<li>'.$event['logo'].'<a href="'.$event['link'].'">'.$event['title'].'</a></li>';
						}
						$case.='</ul>';
					}
					
					$case .= '</td>';
					$tmp = $case.$tmp;
				}
				echo $tmp;
			}
			
			$TempD = 1;
			$Time = mktime(0, 0, 0, $M, 1, $Y);
			while((date('m', $Time) == $M) || (date('w', $Time) != 1)) 
			{
				if(date('w', $Time) == 1) { echo '</tr><tr>'; }
				echo '<td width="14%" height="50" ';
				
				//echo ' class="agenda'.(date('m', $Time) != $M ? 'Not' : '').'This'.(date('Ymd', $Time) == date('Ymd') ? 'Day' : 'Month').'">';
				echo ' class="agenda';
				if(date('m', $Time) == $M)//mois?
				{
					if(date(W) == date(W,$Time))//semaine?
					{
					//jour?
					echo (date('Ymd', $Time) == date('Ymd')) ? 'Day' : 'MonthWeek';
					}
					else
					{echo 'Month';}
					
				}
				else 
				{
					//semaine?
					echo (date(W) == date(W,$Time)) ? 'Week' : '';
				}
				if (isset($events[date('Ymd', $Time)]))
					 echo ' events';
				echo ' ">';
				 
				echo date('j', $Time);
				if (isset($events[date('Ymd', $Time)])) 
				{
				 echo '<ul class="agenda_events">';
					while (list(, $event) = each($events[date('Ymd', $Time)])) 
					{
						echo '<li>'.$event['logo'].'<a href="'.$event['link'].'">'.$event['title'].'</a></li>';
					}
					echo '</ul>';
				}
				echo '</td>';
				$TempD++;
				$Time = mktime(0, 0, 0, $M, $TempD, $Y);
			}
?>

</tr>
</table>

</div>



	<div id="bottombar">
		<div id="search">
			
		</div>
	</div>

	</div>

	<br class="separator"/>
	
	<INCLURE (bottom.php3)>
	


</body>
</html>
