<?php
$_months = array('', 'Janvier', 'F&eacute;vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao&ucirc;t', 'Septembre', 'Octobre', 'Novembre', 'D&eacute;cembre');
$_days = array('D', 'L', 'M', 'M', 'J', 'V', 'S');

$_M = intval(date('m', time()));
$_Y = intval(date('Y', time()));
$_events = array();
$_dates=array();//liste des dates qui ont un evenement.

function _jourSuivant($x){
	//x est une date au format ymd
	//return le jour suivant au meme format
	$m = ereg_replace("^([0-9]{4})([0-9]{2})([0-9]{2}).*$", "\\2", $x);
	$d = ereg_replace("^([0-9]{4})([0-9]{2})([0-9]{2}).*$", "\\3", $x);
	$y = ereg_replace("^([0-9]{4})([0-9]{2})([0-9]{2}).*$", "\\1", $x);
	$jourSuiv = date('Y-m-d',mktime(0,0,0,$m,$d,$y) + (1 * 24 * 60 * 60));
	$jourSuiv = ereg_replace("^([0-9]{4})-([0-9]{2})-([0-9]{2})", "\\1\\2\\3", $jourSuiv);
	return $jourSuiv;
}

function _jourSuivants($day,$nb){
        if($nb<=1) return $day;
	else 	           return _jourSuivants(_jourSuivant($day),$nb-1);
	}

	/* construction liste evenements */
	
	<BOUCLE_evenements(ARTICLES){tout}{type_mot == ^Agenda}>
		//{
			
			$_dateDebut = ereg_replace("^([0-9]{4})-([0-9]{2})-([0-9]{2}).*$", "\\1\\2\\3", '#DATE_REDAC');
			$_sstitre='#SOUSTITRE';
			$_nb_jours[1]=1;
			ereg("([0-9]+) +jour[s]?", $_sstitre, $_nb_jours);
			if ($_nb_jours[1]=="") $_nb_jours[1]=1;
			$_dateFin=_jourSuivants($_dateDebut,$_nb_jours[1]);
		
			for($_d=$_dateDebut; $_d <= $_dateFin; $_d = _jourSuivant($_d)) 
			{
				if (!isset($_events[$_d])) { $_events[$_d] = array(); }
				$_events[$_d][] = array('link' => '#URL_ARTICLE', 'title' => '[(#TITRE)]');
			}
		
	</BOUCLE_evenements>
?>

<?php  ?>


	<script type="text/javascript" language="JavaScript">
		
			
			function showEvents(td){
							 events = td.getElementsByTagName('ul')[0];
							 if(events){
							 						events.style.display='block';
													events.style.position='absolute';
							 }
			}
			
			function hideEvents(td){
							 events = td.getElementsByTagName('ul')[0];
							 if(events){
							 						events.style.display='none';
													/*events.style.position='relative';*/
							 }
			}
		
	</script>

	<!-- agenda miniature: en tete -->	
	<div id="menu-calendar" class="menu-left-block">
	
	<h3><img alt="" src="#DOSSIER_SQUELETTE/IMG/menu-calendar.png"/><a href="agenda.php3" title="Vue du mois">Calendrier</a></h3>
	
	
	
	<table>
	<tbody>
	
	<tr> 
		<th colspan="7" class="agendaNav">
		<?php
			echo '<a href="agenda.php3" title="Vue du mois">'.$_months[$_M].'</a>&nbsp;';
			echo '<a href="page.php3?fond=agenda_annuel" title="Vue de l\'année">'.$_Y.'</a>';
		?>
		</th> 
	</tr>
	
	<!-- agenda miniature: affichage jours et evenements -->
	<tr>
	<?php
	for($_i = 1; $_i < 8; $_i++) { echo '<th>'.$_days[$_i%7].'</th>'; }
	$_TempD = 1;
	$_Time = mktime(0, 0, 0, $_M, 1, $_Y);
	if(date('w', $_Time) != 1) {
		echo '</tr><tr>';
		$_tmp = '';
		while(date('w', $_Time) != 1) {
			$_TempD--;
			$_Time = mktime(0, 0, 0, $_M, $_TempD, $_Y);
			$_case = '<td width="14%" class="agenda" ';
			$_date=date('Ymd', $_Time);
			/*if (isset($_events[$_date])){
			$_case.='onmouseover="showEvents(this);" onmouseout="hideEvents(this);"';
			}*/
		  $_case .='>';
			
			if (isset($_events[$_date])) 
			{
	
				/****/
				$_case.='<ul class="agenda_events">';
				foreach ($_events[$_date] as $ev) { $_case.='<li><a href="'.$ev['link'].'">'.$ev['title'].'</a></li>'; }
				$_case.='</ul>';


				
				$_case .= '<a href="agenda.php3?" title="agenda">';
				
				$_case .= date('j', $_Time).'</a>';
			} else {$_case .= date('j', $_Time);}
			$_tmp = $_case.'</td>'.$_tmp;
		}
		echo $_tmp;
	}
	$_TempD = 1;
	$_Time = mktime(0, 0, 0, $_M, 1, $_Y);	
	

	while((date('m', $_Time) == $_M) || (date('w', $_Time) != 1)) {
		if(date('w', $_Time) == 1) { echo '</tr><tr>'; }
		
		echo '<td width="14%" align="center"';
		
		echo ' class="agenda';
		if(date('m', $_Time) == $_M)//mois?
		{
			if(date(W) == date(W,$_Time))//semaine?
			{
			    //jour?
				echo (date('Ymd', $_Time) == date('Ymd')) ? 'Day' : 'MonthWeek';
			}
			else
			{echo 'Month';}
		}
		else 
		{
			//semaine?
			echo (date(W) == date(W,$_Time)) ? 'Week' : '';
		}
		
		echo '"';
		$_date=date('Ymd', $_Time);
		/*	if (isset($_events[$_date])){
			echo ' onmouseover="showEvents(this);" onmouseout="hideEvents(this);"';
			}
			*/
		if (isset($_events[$_date]))
		{
			//Pour voir les noms des events en passant la souris sur la case du jour.
			$_dates[]=$_date;
			
			//argument pour la fonction javascript (à conserver si on remet du javascript)
			//$tab_js="(";
			//foreach ($_events[$_date] as $ev){$tab_js.='\''.$ev['title'].'\',';}
			//$tab_js.=")";
			//$tab_js = str_replace(",)", ")", $tab_js);

			//echo " onmouseover=\"javascript:creerEncart('menu-calendar','bidon',new Array".$tab_js.");\" ";
			//echo " onmouseout=\"javascript:effacerEncart('menu-calendar','encart');\" ";

		
			
			echo ' >';
			//tag <td>
			
			/****/
			echo '<ul class="agenda_events">';
			foreach ($_events[$_date] as $ev) { echo '<li><a href="'.$ev['link'].'">'.$ev['title'].'</a></li>'; }
			echo '</ul>';

			
			echo '<a href="agenda.php3?" title="agenda">';
			
			echo date('j', $_Time).'</a>';
		} 
		else 
		{
			echo ' >'.date('j', $_Time);
		}
		echo '</td>';
		$_TempD++;
		$_Time = mktime(0, 0, 0, $_M, $_TempD, $_Y);
	}
	?>
	</tr>
	
	</tbody>
	</table>
	<!-- fausse div pour faire marcher l'insertion dynamique en javascript-->
	<!--<i id=bidon></i>-->
	</div>
	